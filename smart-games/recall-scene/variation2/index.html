<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SMART Colour Memory Game</title>
  <style>
    body {
      background-color: #fcefe3;
      font-family: 'Arial', sans-serif;
      color: black;
      text-align: center;
      margin: 0;
      padding: 0;
    }

    h1 {
      margin-top: 20px;
      font-size: 22px;
    }

    .banner {
      background-color: #a8dadc;
      padding: 15px;
      font-size: 20px;
      font-weight: bold;
    }

    .game-area {
      margin: 20px auto;
      max-width: 600px;
      position: relative;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-top: 20px;
    }

    .cell {
      width: 90px;
      height: 90px;
      border-radius: 10px;
    }

    .hidden {
      display: none;
    }

    .message {
      font-size: 16px;
      margin-top: 10px;
    }

    button {
      background-color: #a8dadc;
      border: none;
      color: black;
      padding: 10px 20px;
      margin: 20px 10px;
      font-size: 16px;
      border-radius: 10px;
      cursor: pointer;
    }

    input[type="text"] {
      padding: 8px;
      font-size: 16px;
      margin: 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
      width: 90%;
      max-width: 300px;
    }

    #roundCounter {
      position: fixed;
      bottom: 10px;
      left: 10px;
      background: #a8dadc;
      padding: 8px 12px;
      border-radius: 8px;
      font-weight: bold;
      z-index: 1000;
      user-select: none;
      font-size: 14px;
    }

    #finalSummary {
      margin-top: 40px;
      font-size: 18px;
      background: #e1f0f7;
      border-radius: 10px;
      padding: 30px;
      display: none;
    }

    #correctDisplay {
      font-size: 16px;
      margin-top: 20px;
      background: #f0f0f0;
      border-radius: 10px;
      padding: 15px;
      display: none;
    }

    .display-colors {
      margin-top: 10px;
      display: flex;
      justify-content: center;
      gap: 10px;
    }

    .color-box {
      width: 40px;
      height: 40px;
      border-radius: 5px;
      border: 1px solid #000;
    }

    /* Container for title + moved countdown and prompt */
    #topInfo {
      max-width: 600px;
      margin: 0 auto 0;
    }
  </style>
</head>
<body>
  <div class="banner" id="welcomeBanner">Welcome to the SMART memory game!</div>

  <div id="topInfo">
    <h1>üé® SMART Colour Memory Game üé®</h1>
    <p id="instruction">Memorize the colors in the grid! You'll be asked to recall a specific row or column.</p>
    <p id="prompt" class="message hidden"></p>
    <p id="countdown" class="message hidden">‚è≥ Time left to remember: <span id="timer">60</span> seconds</p>
  </div>

  <div id="roundCounter" class="message">Round 0 of 5 ‚Äî 5 rounds remaining</div>

  <div class="game-area">
    <div id="grid" class="grid"></div>

    <div id="input-area" class="hidden">
      <p>Type the colors in order (like "red, blue, yellow"):</p>
      <input type="text" id="answer" placeholder="e.g. red, yellow, blue" autocomplete="off"/>
      <button id="submit">Submit</button>
    </div>

    <div id="result" class="hidden"></div>
    <div id="correctDisplay"></div>
    <button id="start">Start Game</button>
    <button id="next" class="hidden">Next Round</button>
    <div id="finalSummary"></div>
  </div>

  <script>
    const simpleColors = ["red", "blue", "green", "yellow", "orange", "purple", "black"];
    const totalRounds = 5;

    const gridDiv = document.getElementById("grid");
    const promptP = document.getElementById("prompt");
    const countdownP = document.getElementById("countdown");
    const timerSpan = document.getElementById("timer");
    const inputArea = document.getElementById("input-area");
    const answerInput = document.getElementById("answer");
    const submitBtn = document.getElementById("submit");
    const resultDiv = document.getElementById("result");
    const correctDisplay = document.getElementById("correctDisplay");
    const startBtn = document.getElementById("start");
    const nextBtn = document.getElementById("next");
    const roundCounter = document.getElementById("roundCounter");
    const finalSummary = document.getElementById("finalSummary");
    const welcomeBanner = document.getElementById("welcomeBanner");
    const instructionP = document.getElementById("instruction");

    let currentRound = 0;
    let grid = [];
    let recallSet = [];
    let promptText = "";
    let timer = null;
    let timeLeft = 60;
    let score = 0;

    function normalizeColor(input) {
      return input.toLowerCase().trim();
    }

    function createGrid() {
      const chosen = [];
      while (chosen.length < 16) {
        simpleColors.forEach(color => {
          if (chosen.length < 16) chosen.push(color);
        });
      }
      for (let i = chosen.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [chosen[i], chosen[j]] = [chosen[j], chosen[i]];
      }
      grid = [];
      for (let i = 0; i < 4; i++) {
        grid.push(chosen.slice(i * 4, i * 4 + 4));
      }
    }

    function showGrid() {
      gridDiv.innerHTML = "";
      grid.forEach(row => {
        row.forEach(c => {
          const cell = document.createElement("div");
          cell.className = "cell";
          cell.style.backgroundColor = c;
          gridDiv.appendChild(cell);
        });
      });
      gridDiv.classList.remove("hidden");
    }

    function startRound() {
      currentRound++;
      roundCounter.textContent = currentRound === totalRounds
        ? "Last Round!"
        : `Round ${currentRound} of ${totalRounds} ‚Äî ${totalRounds - currentRound} rounds remaining`;

      resultDiv.classList.add("hidden");
      correctDisplay.style.display = "none";
      inputArea.classList.add("hidden");
      answerInput.value = "";
      promptP.classList.remove("hidden");
      countdownP.classList.remove("hidden");
      nextBtn.classList.add("hidden");

      createGrid();
      showGrid();

      const isRow = Math.random() < 0.5;
      const index = Math.floor(Math.random() * 4);
      promptText = `${isRow ? "row" : "column"} ${index + 1}`;
      recallSet = isRow ? grid[index] : grid.map(r => r[index]);

      promptP.textContent = `Remember the colors in ${promptText}`;
      timeLeft = 60;
      timerSpan.textContent = timeLeft;

      timer = setInterval(() => {
        timeLeft--;
        timerSpan.textContent = timeLeft;
        if (timeLeft <= 0) {
          clearInterval(timer);
          startRecall();
        }
      }, 1000);

      startBtn.classList.add("hidden");
    }

    function startRecall() {
      gridDiv.classList.add("hidden");
      countdownP.classList.add("hidden");
      promptP.textContent = `Enter the colors in ${promptText}`;
      inputArea.classList.remove("hidden");
      answerInput.focus();
    }

    function checkAnswer() {
      clearInterval(timer);
      const user = answerInput.value.split(",").map(s => normalizeColor(s));
      const correctColors = recallSet.map(normalizeColor);
      let correctCount = 0;
      const matched = new Set();

      user.forEach(color => {
        const idx = correctColors.findIndex((c, i) => c === color && !matched.has(i));
        if (idx !== -1) {
          correctCount++;
          matched.add(idx);
        }
      });

      score += correctCount;

      resultDiv.textContent = `You got ${correctCount} correct color${correctCount !== 1 ? "s" : ""}!`;
      resultDiv.classList.remove("hidden");
      inputArea.classList.add("hidden");

      correctDisplay.style.display = "block";
      correctDisplay.innerHTML = `
        <strong>Correct:</strong><div class="display-colors">${
          recallSet.map(c => `<div class="color-box" style="background:${c}"></div>`).join('')
        }</div>
        <strong>Your answer:</strong><div class="display-colors">${
          user.map(c => `<div class="color-box" style="background:${c}"></div>`).join('')
        }</div>
      `;

      if (currentRound < totalRounds) {
        nextBtn.classList.remove("hidden");
      } else {
        finalSummary.style.display = "block";
        finalSummary.innerHTML = `
          Game over! Your total score: ${score} out of ${totalRounds * 4}.<br><br>
          <strong>Now, finish the survey and you will have earned an extra $2.50 for your SMART bank.</strong>
        `;
        startBtn.textContent = "Play Again";
        startBtn.classList.remove("hidden");
        window.parent.postMessage("showNext", "*");
      }
    }

    startBtn.addEventListener("click", () => {
      // Hide welcome banner on start
      welcomeBanner.style.display = "none";
      // Hide the instruction paragraph after first start
      instructionP.style.display = "none";

      finalSummary.style.display = "none";
      currentRound = 0;
      score = 0;
      startRound();
    });

    submitBtn.addEventListener("click", () => {
      if (!answerInput.value.trim()) {
        alert("Please enter your answer.");
        return;
      }
      checkAnswer();
    });

    nextBtn.addEventListener("click", () => {
      nextBtn.classList.add("hidden");
      resultDiv.classList.add("hidden");
      correctDisplay.style.display = "none";
      gridDiv.classList.remove("hidden");
      promptP.classList.remove("hidden");
      countdownP.classList.remove("hidden");
      inputArea.classList.add("hidden");
      startRound();
    });

    answerInput.addEventListener("keydown", e => {
      if (e.key === "Enter") {
        e.preventDefault();
        submitBtn.click();
      }
    });
  </script>
</body>
</html>
