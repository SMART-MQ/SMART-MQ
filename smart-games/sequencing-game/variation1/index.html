<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SMART Sequence Challenge</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-color: #f3e8ff;
      --primary-color: #4b0082;
      --accent-color: #ff7f50;
      --accent-shadow: #e06c3a;
      --light-lavender: #e6e6fa;
      --text-color: #3d3d3d;
    }

    * { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
      font-family: 'Fredoka One', cursive;
      background-color: var(--bg-color);
      color: var(--text-color);
      text-align: center;
      overflow-x: hidden;
    }
    
    .hidden { display: none !important; }
    .fadeable { transition: opacity 0.4s ease-in-out, visibility 0.4s; }
    .is-faded-out { opacity: 0; visibility: hidden; pointer-events: none; }

    /* --- Screens & Overlays --- */
    .screen {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.6); z-index: 1000; display: flex;
      justify-content: center; align-items: center; padding: 15px;
    }
    
    .overlay-content {
      background-color: var(--light-lavender); padding: 20px; border-radius: 20px; 
      border: 4px solid var(--primary-color); width: 100%; max-width: 500px;
      max-height: 90vh; overflow-y: auto;
    }

    /* --- Typography & Titles --- */
    h1 {
      font-size: clamp(2.5em, 10vw, 4em);
      color: var(--primary-color);
      text-shadow: 4px 4px 0px var(--accent-color);
      margin: 0 0 20px 0;
    }
    
    h2 {
      font-size: clamp(1.5em, 6vw, 2em);
      color: var(--primary-color);
    }

    ul { list-style-type: none; padding: 0; text-align: left; max-width: 350px; margin: 20px auto; }
    ul li { font-size: clamp(1em, 4vw, 1.2em); margin-bottom: 12px; line-height: 1.4; }
    ul li::before { content: '‚≠ê'; margin-right: 10px; }
    
    /* --- Game Area --- */
    #game-area { width: 100%; max-width: 600px; }
    .scoreboard { display: flex; justify-content: space-around; font-size: 1.2em; margin-bottom: 15px; }
    #message { font-size: 1.3em; color: var(--primary-color); min-height: 1.5em; margin: 15px 0; font-weight: bold; }

    .timer-bar-container {
      width: 90%; max-width: 500px; height: 25px; background-color: #e9ecef;
      border-radius: 10px; border: 3px solid var(--primary-color);
      margin: 15px auto; overflow: hidden;
    }
    .timer-bar {
      height: 100%; width: 100%; background-color: #32cd32;
      border-radius: 6px; transition: width 1s linear;
    }

    .button-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 20px;
      max-width: 400px;
      margin: 0 auto;
    }

    .color-button {
      aspect-ratio: 1 / 1;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.1s ease-out;
    }
    #btn1 { background-color: #ffb3ba; box-shadow: 0 8px 0 #e08a91; }
    #btn2 { background-color: #ffdfba; box-shadow: 0 8px 0 #e0b98a; }
    #btn3 { background-color: #baffc9; box-shadow: 0 8px 0 #8ad89b; }
    #btn4 { background-color: #bae1ff; box-shadow: 0 8px 0 #8ab8de; }

    .color-button:active:not(:disabled) { transform: translateY(4px); }
    #btn1:active:not(:disabled) { box-shadow: 0 4px 0 #e08a91; }
    #btn2:active:not(:disabled) { box-shadow: 0 4px 0 #e0b98a; }
    #btn3:active:not(:disabled) { box-shadow: 0 4px 0 #8ad89b; }
    #btn4:active:not(:disabled) { box-shadow: 0 4px 0 #8ab8de; }
    
    .color-button:disabled { opacity: 0.7; cursor: not-allowed; }

    .color-button.flash {
      transform: translateY(4px) scale(0.95);
      filter: brightness(1.2);
    }
    
    @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } }
    .shake-container { animation: shake 0.4s; }

    /* --- Buttons & Misc --- */
    .play-button {
      background-color: var(--accent-color); border: none; color: white;
      padding: 15px 30px; margin-top: 10px; font-size: 1.3em;
      font-family: 'Fredoka One', cursive; border-radius: 12px;
      cursor: pointer; transition: all 0.2s ease;
      box-shadow: 0 6px 0 var(--accent-shadow); text-transform: uppercase;
    }
    .play-button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 8px 0 var(--accent-shadow); }

    .help-button {
      position: fixed; bottom: 15px; right: 15px; width: 55px; height: 55px;
      border-radius: 50%; font-size: 2em; z-index: 500;
      background-color: var(--primary-color); color: white;
      border: 3px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      cursor: pointer; line-height: 1;
    }
    
    #fanfare {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background-color: rgba(75, 0, 130, 0.9); color: white; padding: 20px 40px;
      border-radius: 20px; font-size: 3em; z-index: 9999;
    }
    @keyframes fanfare-anim { 0% { opacity: 0; } 50% { opacity: 1; } 100% { opacity: 0; } }
    .fanfare-animate { animation: fanfare-anim 1.5s ease-in-out; }

  </style>
</head>
<body>

  <!-- Start Screen -->
  <div id="start-screen" class="screen">
    <h1>Sequence Challenge</h1>
    <p>This is a challenge just for you. Try to beat your best score each round!</p>
    <button class="play-button" id="startBtn">Play</button>
  </div>

  <!-- Game Screen -->
  <div id="game-screen" class="screen hidden">
    <div id="game-area">
      <div id="timer-bar-container" class="timer-bar-container">
        <div id="timer-bar" class="timer-bar"></div>
      </div>
      <div class="scoreboard">
        <span id="currentScore">Score: 0</span>
        <span id="bestScore">Best: 0</span>
      </div>
      <p id="message">Get Ready...</p>
      <div id="button-container" class="button-container">
        <button class="color-button" id="btn1"></button>
        <button class="color-button" id="btn2"></button>
        <button class="color-button" id="btn3"></button>
        <button class="color-button" id="btn4"></button>
      </div>
    </div>
  </div>

  <!-- Help Button -->
  <button id="helpBtn" class="help-button hidden">?</button>
  
  <!-- Fanfare Message -->
  <div id="fanfare" class="hidden"></div>

  <!-- Help Overlay -->
  <div id="help-overlay" class="overlay fadeable is-faded-out">
    <div class="overlay-content">
      <h2>Instructions</h2>
      <ul>
        <li>Watch the sequence of colours.</li>
        <li>Repeat the pattern by pressing the buttons in the same order.</li>
        <li>Each correct round adds a new colour to the sequence.</li>
        <li>Get the highest score you can before time runs out!</li>
      </ul>
      <button class="play-button" id="resumeBtn">Resume</button>
    </div>
  </div>

  <!-- Final Summary Overlay -->
  <div id="final-summary-overlay" class="overlay fadeable is-faded-out">
    <div class="overlay-content">
      <h2>Time's Up!</h2>
      <p style="font-size: 1.2em;">Your personal best was:</p>
      <p id="final-best-score" style="font-size: 2.5em; color: var(--primary-color); margin: 10px 0;">0</p>
      <p>Make sure you press the red arrow on the bottom right of the screen to finish.</p>
      <button class="play-button" onclick="location.reload()">Play Again</button>
    </div>
  </div>

  <audio id="flashSound" src="https://www.soundjay.com/button/beep-07.mp3" preload="auto"></audio>
  <audio id="wrongSound" src="https://www.soundjay.com/button/beep-10.mp3" preload="auto"></audio>

  <script>
    const GAME_TIME = 300; // 5 minutes in seconds

    // --- Element Cache ---
    const elements = {
        startScreen: document.getElementById('start-screen'),
        gameScreen: document.getElementById('game-screen'),
        startBtn: document.getElementById('startBtn'),
        message: document.getElementById('message'),
        timerBar: document.getElementById('timer-bar'),
        buttonContainer: document.getElementById('button-container'),
        buttons: ["btn1", "btn2", "btn3", "btn4"].map(id => document.getElementById(id)),
        currentScoreEl: document.getElementById('currentScore'),
        bestScoreEl: document.getElementById('bestScore'),
        helpBtn: document.getElementById('helpBtn'),
        helpOverlay: document.getElementById('help-overlay'),
        resumeBtn: document.getElementById('resumeBtn'),
        finalOverlay: document.getElementById('final-summary-overlay'),
        finalBestScore: document.getElementById('final-best-score'),
        fanfare: document.getElementById('fanfare'),
        flashSound: document.getElementById('flashSound'),
        wrongSound: document.getElementById('wrongSound'),
    };

    // --- Game State ---
    let sequence = [], userSequence = [], score = 0, best = 0;
    let timer, timeLeft = GAME_TIME;
    let isPlayerTurn = false, isGameRunning = false, isPaused = false;

    // --- Event Listeners ---
    elements.startBtn.addEventListener('click', startGame);
    elements.helpBtn.addEventListener('click', pauseGame);
    elements.resumeBtn.addEventListener('click', resumeGame);
    elements.buttons.forEach((btn, i) => {
      btn.addEventListener('click', () => handlePlayerInput(i));
    });

    // --- Game Flow ---
    function startGame() {
      elements.startScreen.classList.add('hidden');
      elements.gameScreen.classList.remove('hidden');
      elements.helpBtn.classList.remove('hidden');

      triggerFanfare("Let's Go!", 1500);

      setTimeout(() => {
        isGameRunning = true;
        startTimer();
        nextRound();
      }, 1500);
    }
    
    function nextRound() {
      if (!isGameRunning) return;
      
      isPlayerTurn = false;
      userSequence = [];
      updateButtonsState(true); // Disable buttons
      elements.message.textContent = 'Watch carefully...';
      
      sequence.push(Math.floor(Math.random() * 4));
      playSequence();
      
      // Schedule player's turn after sequence playback
      setTimeout(() => {
        isPlayerTurn = true;
        updateButtonsState(false); // Enable buttons
        elements.message.textContent = 'Your turn!';
      }, sequence.length * 700 + 400); // Sequence speed + buffer
    }
    
    function endGame() {
        isGameRunning = false;
        clearInterval(timer);
        elements.finalBestScore.textContent = best;
        elements.finalOverlay.classList.remove('is-faded-out');
        elements.helpBtn.classList.add('hidden');
        updateButtonsState(true);
        window.parent.postMessage("showNext", "*");
    }

    // --- Player Interaction ---
    function handlePlayerInput(index) {
        if (!isPlayerTurn) return;
        
        flashButton(elements.buttons[index]);
        userSequence.push(index);
        
        // Check if the current press is correct
        if (userSequence[userSequence.length - 1] !== sequence[userSequence.length - 1]) {
            handleIncorrect();
            return;
        }
        
        // Check if the full sequence has been entered
        if (userSequence.length === sequence.length) {
            handleCorrect();
        }
    }
    
    function handleCorrect() {
        isPlayerTurn = false; // Prevent further clicks
        score++;
        if (score > best) {
            best = score;
            elements.message.textContent = 'New Best!';
        } else {
            elements.message.textContent = 'Correct!';
        }
        updateScoreboard();
        setTimeout(nextRound, 1000);
    }
    
    function handleIncorrect() {
        isPlayerTurn = false; // Prevent further clicks
        elements.wrongSound.play();
        elements.message.textContent = 'Oops! Try again.';
        elements.buttonContainer.classList.add('shake-container');
        
        // Reset game state
        score = 0;
        sequence = [];
        updateScoreboard();
        
        setTimeout(() => {
            elements.buttonContainer.classList.remove('shake-container');
            nextRound();
        }, 1500);
    }
    
    // --- Timers & Pausing ---
    function startTimer() {
        timer = setInterval(() => {
            if (isPaused || !isGameRunning) return;
            timeLeft--;
            elements.timerBar.style.width = (timeLeft / GAME_TIME) * 100 + '%';
            if (timeLeft <= 0) {
                endGame();
            }
        }, 1000);
    }

    function pauseGame() {
        if (!isGameRunning) return;
        isPaused = true;
        elements.helpOverlay.classList.remove('is-faded-out');
    }

    function resumeGame() {
        isPaused = false;
        elements.helpOverlay.classList.add('is-faded-out');
    }
    
    // --- Visual & Audio Feedback ---
    function playSequence() {
      let i = 0;
      const interval = setInterval(() => {
        if(i >= sequence.length) {
            clearInterval(interval);
            return;
        }
        flashButton(elements.buttons[sequence[i]]);
        i++;
      }, 700); // Slightly faster sequence
    }
    
    function flashButton(btn) {
        elements.flashSound.currentTime = 0;
        elements.flashSound.play();
        btn.classList.add("flash");
        setTimeout(() => btn.classList.remove("flash"), 350);
    }
    
    function triggerFanfare(text, duration) {
        elements.fanfare.textContent = text;
        elements.fanfare.classList.remove('hidden', 'fanfare-animate');
        void elements.fanfare.offsetWidth; // Trigger reflow to restart animation
        elements.fanfare.classList.add('fanfare-animate');
        setTimeout(() => elements.fanfare.classList.add('hidden'), duration);
    }
    
    // --- UI Updates ---
    function updateScoreboard() {
        elements.currentScoreEl.textContent = `Score: ${score}`;
        elements.bestScoreEl.textContent = `Best: ${best}`;
    }

    function updateButtonsState(disabled) {
        elements.buttons.forEach(btn => btn.disabled = disabled);
    }

  </script>
</body>
</html>
