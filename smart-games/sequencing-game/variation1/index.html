<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SMART Sequence Challenge</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      font-family: 'Arial Rounded MT Bold', sans-serif;
      background: linear-gradient(to bottom right, #fce4ec, #e1f5fe);
      height: 100%;
      color: #333;
    }

    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
      overflow-x: hidden;
      padding-top: 10vh;
    }

    .content {
      width: 90vw;
      max-width: 600px;
      padding: 5vw;
      margin-top: 5vh;
      background: white;
      border-radius: 20px;
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
      text-align: center;
      position: relative;
    }

    h1 {
      font-size: 6vw;
      background: linear-gradient(90deg, #ffb3ba, #ffdfba, #ffffba, #baffc9, #bae1ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-weight: bold;
    }

    h2, .score {
      font-size: 4.5vw;
      color: #444;
      margin: 10px 0;
    }

    p, #message {
      font-size: 4vw;
      color: #555;
      margin: 10px 0;
      min-height: 1.2em; /* Change: Ensures space is reserved for messages */
    }

    .play-button {
      font-size: 4.5vw;
      padding: 10px 20px;
      background-color: #ffd6e8;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      margin-top: 20px;
    }

    .button-container {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 5vw;
      margin-top: 20px;
    }

    .color-button {
      width: 22vw;
      height: 22vw;
      border: 4px solid transparent;
      border-radius: 20px;
      box-shadow: 2px 2px 8px rgba(0,0,0,0.2);
      cursor: pointer;
      transition: transform 0.2s, opacity 0.2s, border 0.2s;
    }

    .color-button:disabled {
        cursor: not-allowed;
        opacity: 0.6;
    }

    .color-button.flash {
      opacity: 0.4 !important;
      transform: scale(1.1);
      border: 4px solid #555;
    }

    .scoreboard {
      display: flex;
      justify-content: space-between;
      gap: 5vw;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    
    /* Change: Container for timer and help button */
    .game-footer {
        position: fixed;
        bottom: 15px;
        right: 15px;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    #timerBox {
      background: #ffffffcc;
      padding: 10px 20px;
      border-radius: 10px;
      font-size: 5vw;
      font-weight: bold;
      color: #222;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    
    /* Change: Style for new help button */
    #helpButton {
        width: 12vw;
        height: 12vw;
        max-width: 50px;
        max-height: 50px;
        border-radius: 50%;
        border: none;
        background-color: #bae1ff;
        color: white;
        font-size: 7vw;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
        display: flex;
        justify-content: center;
        align-items: center;
    }

    #instructionModal, #finalPopup {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: linear-gradient(to bottom right, #fce4ec, #e1f5fe);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 999;
      padding: 5vw;
      box-sizing: border-box;
    }

    #instructionBox, #finalPopup > div {
      background: white;
      padding: 5vw;
      border-radius: 15px;
      max-width: 90vw;
      width: 100%;
      text-align: center;
      box-sizing: border-box;
    }

    #instructionBox h2, #finalPopup h2 {
      font-size: 5vw;
      background: linear-gradient(90deg, #ffb3ba, #ffdfba);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    #instructionBox ul {
      list-style-type: disc;
      padding-left: 5vw;
      line-height: 1.8;
      text-align: left;
      font-size: 4vw;
    }

    #countdownBox {
      font-size: 6vw;
      font-weight: bold;
      display: none;
    }

  </style>
</head>
<body>
  <div class="content" id="startScreen">
    <!-- Change (2): Game given a unique name -->
    <h1>Welcome to Sequence Challenge!</h1>
    <p><strong>This is a challenge just for you. Try to beat your best score each round!</strong></p>
    <button class="play-button" onclick="showInstructions()">Play</button>
  </div>

  <div id="instructionModal">
    <div id="instructionBox">
      <h2>Instructions</h2>
      <ul>
        <li>Watch the sequence of colours flash on the screen.</li>
        <!-- Change (5): "clicking" changed to "pressing" -->
        <li>Repeat the pattern by pressing the buttons in the same order.</li>
        <li>Each round adds a new colour to the sequence.</li>
        <!-- Change (1): "10 minutes" changed to "5 minutes" -->
        <li>Try to get the highest score in 5 minutes!</li>
      </ul>
      <!-- Change (6): Added an ID to the button to control its text/function -->
      <button class="play-button" id="modalStartButton" onclick="startCountdown()">Start</button>
    </div>
  </div>

  <div class="content" id="gameArea" style="display:none">
    <h2 id="roundTitle">Try and beat your personal best to get the highest score!</h2>
    <div class="scoreboard">
      <p class="score" id="currentScore">Current Score: 0</p>
      <p class="score" id="bestScore">Personal Best: 0</p>
    </div>
    <div id="countdownBox"></div>
    <div class="button-container" id="buttonContainer">
      <button class="color-button" id="btn1" style="background-color: #ffb3ba;"></button>
      <button class="color-button" id="btn2" style="background-color: #ffdfba;"></button>
      <button class="color-button" id="btn3" style="background-color: #baffc9;"></button>
      <button class="color-button" id="btn4" style="background-color: #bae1ff;"></button>
    </div>
    <!-- Change (9): This message element will now show turn prompts -->
    <p id="message"></p>
  </div>
  
  <!-- Change (6): Footer for timer and new help button -->
  <div class="game-footer" id="gameFooter" style="display: none;">
      <button id="helpButton" onclick="showHelp()">?</button>
      <div id="timerBox">05:00</div>
  </div>


  <div id="finalPopup">
    <div>
      <h2>Congratulations!</h2>
      <!-- Change (3 & 4): Updated final message and added new prompt -->
      <p id="finalMessage">Your personal best was: 0</p>
      <p>Make sure you press the red arrow on the bottom right of the screen to finish.</p>
    </div>
  </div>

  <audio id="flashSound" src="https://www.soundjay.com/button/beep-07.mp3" preload="auto"></audio>
  <audio id="wrongSound" src="https://www.soundjay.com/button/beep-10.mp3" preload="auto"></audio>

  <script>
    // Change (1): timeLeft is now 300 seconds (5 minutes)
    let sequence = [], userSequence = [], score = 0, best = 0, timer, timeLeft = 300;
    // Change (9): isPlayerTurn flag to manage game state and disable buttons
    let isPlayerTurn = false; 

    const buttons = ["btn1", "btn2", "btn3", "btn4"].map(id => document.getElementById(id));
    const flashSound = document.getElementById("flashSound");
    const wrongSound = document.getElementById("wrongSound");
    const messageEl = document.getElementById("message");
    const modalStartButton = document.getElementById("modalStartButton");

    buttons.forEach((btn, i) => {
      btn.addEventListener("click", () => {
        // Change (9): Only allow clicks during the player's turn
        if (!isPlayerTurn) return; 
        flashButton(btn);
        userSequence.push(i);
        checkUserInput();
      });
    });

    function showInstructions() {
      document.getElementById("startScreen").style.display = "none";
      document.getElementById("instructionModal").style.display = "flex";
    }

    function startCountdown() {
      document.getElementById("instructionModal").style.display = "none";
      document.getElementById("gameArea").style.display = "block";
      document.getElementById("gameFooter").style.display = "flex"; // Change: Show footer
      let countdown = 3;
      const box = document.getElementById("countdownBox");
      box.style.display = "block";
      box.textContent = countdown;
      const countdownInterval = setInterval(() => {
        countdown--;
        if (countdown > 0) {
          box.textContent = countdown;
        } else {
          clearInterval(countdownInterval);
          box.style.display = "none";
          startTimer();
          nextRound();
        }
      }, 1000);
    }

    function flashButton(btn) {
      flashSound.currentTime = 0;
      flashSound.play();
      btn.classList.add("flash");
      setTimeout(() => btn.classList.remove("flash"), 500);
    }

    function playSequence() {
      let i = 0;
      const interval = setInterval(() => {
        flashButton(buttons[sequence[i]]);
        i++;
        if (i >= sequence.length) clearInterval(interval);
      }, 800);
    }

    function checkUserInput() {
      const index = userSequence.length - 1;
      if (userSequence[index] !== sequence[index]) {
        wrongSound.play();
        messageEl.textContent = "Try again!";
        sequence = [], userSequence = [], score = 0;
        document.getElementById("currentScore").textContent = `Current Score: ${score}`;
        // Delay next round to allow "Try again" message to be seen
        setTimeout(nextRound, 1500);
        return;
      }
      if (userSequence.length === sequence.length) {
        score++;
        best = Math.max(best, score);
        messageEl.textContent = score === best ? "New personal best!" : "Well done!";
        document.getElementById("currentScore").textContent = `Current Score: ${score}`;
        document.getElementById("bestScore").textContent = `Personal Best: ${best}`;
        userSequence = [];
        // Delay next round to allow "Well done!" message to be seen
        setTimeout(nextRound, 1000);
      }
    }

    function nextRound() {
      // Change (10): Clear previous message (e.g., "Try again" or "Well done")
      messageEl.textContent = ""; 
      isPlayerTurn = false;
      buttons.forEach(btn => btn.disabled = true); // Disable buttons during sequence playback

      // Change (9): Add prompt for computer's turn
      messageEl.textContent = "Watch carefully...";

      sequence.push(Math.floor(Math.random() * 4));
      playSequence();

      // Change (9): Set a timeout to switch to the player's turn after the sequence has finished playing
      setTimeout(() => {
        messageEl.textContent = "Your turn!";
        isPlayerTurn = true;
        buttons.forEach(btn => btn.disabled = false); // Re-enable buttons
      }, sequence.length * 800 + 400); // Add a small buffer
    }

    function startTimer() {
      // Change (6): Ensure the timer variable is cleared before setting a new one
      if(timer) clearInterval(timer);
      timer = setInterval(() => {
        timeLeft--;
        const m = String(Math.floor(timeLeft / 60)).padStart(2, '0');
        const s = String(timeLeft % 60).padStart(2, '0');
        document.getElementById("timerBox").textContent = `${m}:${s}`;
        if (timeLeft <= 0) {
          clearInterval(timer);
          messageEl.textContent = "Time's up!";
          buttons.forEach(btn => btn.disabled = true); // Disable buttons when time is up
          showFinalPopup();
        }
      }, 1000);
    }
    
    // Change (6): New function to show help/instructions mid-game
    function showHelp() {
        if (timeLeft <= 0) return; // Don't show if game is over
        clearInterval(timer);
        buttons.forEach(btn => btn.disabled = true);
        
        modalStartButton.textContent = "Resume";
        modalStartButton.onclick = resumeGame; // Change button function
        
        document.getElementById("instructionModal").style.display = "flex";
    }

    // Change (6): New function to resume the game from the instruction modal
    function resumeGame() {
        document.getElementById("instructionModal").style.display = "none";
        if(isPlayerTurn) { // Only enable buttons if it was the player's turn
            buttons.forEach(btn => btn.disabled = false);
        }
        startTimer(); // Resume timer
    }

    function showFinalPopup() {
      document.getElementById("finalMessage").textContent = `Your personal best was: ${best}`;
      document.getElementById("finalPopup").style.display = "flex";
      // This message helps integrate with the external platform if needed
      // window.parent.postMessage("showNext", "*"); 
    }
  </script>
</body>
</html>
